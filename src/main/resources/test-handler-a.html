<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –∫–æ–º–Ω–∞—Ç–∞–º–∏</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #log {
        white-space: pre-wrap;
        background: #f0f0f0;
        padding: 10px;
        border-radius: 5px;
        max-height: 300px;
        overflow-y: auto;
      }
      input,
      select,
      button {
        margin-top: 10px;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>WebSocket: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è + –ö–æ–º–Ω–∞—Ç—ã</h1>

    <label>–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</label>
    <input
      type="text"
      id="tokenInput"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, JWT)"
    />

    <label>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–Ω–∞—Ç—É:</label>
    <select id="roomSelect">
      <option value="room1">–ö–æ–º–Ω–∞—Ç–∞ 1</option>
      <option value="room2">–ö–æ–º–Ω–∞—Ç–∞ 2</option>
      <option value="room3">–ö–æ–º–Ω–∞—Ç–∞ 3</option>
    </select>

    <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="closeWebSocket()">–ó–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>

    <hr />

    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
    <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <div id="log"></div>

    <script>
      let socket;

      const log = (msg) => {
        document.getElementById("log").textContent += msg + "\n";
      };

      function closeWebSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          console.log("üîå –ó–∞–∫—Ä—ã–≤–∞—é WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
          socket.close(1000, "–ö–ª–∏–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"); // 1000 ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        } else if (socket && socket.readyState === WebSocket.CLOSING) {
          console.log("‚è≥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è...");
        } else if (socket && socket.readyState === WebSocket.CLOSED) {
          console.log("‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä—ã—Ç–æ.");
        } else {
          console.log(
            "‚ö†Ô∏è WebSocket –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ CONNECTING."
          );
        }
      }

      function connect() {
        const token = document.getElementById("tokenInput").value.trim();
        const room = document.getElementById("roomSelect").value;

        if (!token) {
          log("‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
          return;
        }

        const url = `ws://localhost:8080/handler-a?token=${encodeURIComponent(
          token
        )}&room=${encodeURIComponent(room)}`;

        socket = new WebSocket(url);
        socket.onopen = () => log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ "${room}"`);
        socket.onmessage = (event) => log("üì® –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + event.data);
        socket.onerror = (error) =>
          log("‚ùå –û—à–∏–±–∫–∞ WebSocket: " + error.message);
        socket.onclose = () => log("üîí –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value;
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(message);
          input.value = "";
        } else {
          log("‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç–æ");
        }
      }
    </script>
  </body>
</html>
